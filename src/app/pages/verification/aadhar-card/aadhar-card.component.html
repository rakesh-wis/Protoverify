<div class="container-fluid page-padding">
	<div
		class="d-flex justify-content-between align-items-center"
		*ngIf="![roles.EMPLOYEE].includes(currentUser?.role)"
	>
		<label class="text-custom-black-80 fs-4 fw-bold"> {{ userData?.name }}'s Verification Details </label>
	</div>
	<div *ngIf="![roles.EMPLOYEE].includes(currentUser?.role)">
		<app-status-bar
			[inputData]="form['id'].value ? dataForm.getRawValue() : null"
			[currentUser]="currentUser"
		></app-status-bar>
	</div>
	<div class="card my-4 px-3" [ngClass]="{ 'opacity-50': isFormDisabled }">
		<div class="card-header bg-transparent">
			<div class="d-flex justify-content-between align-items-center">
				<div class="d-flex justify-content-start align-items-center py-2">
					<img src="assets/images/kyc_aadhar.svg" class="img-fluid" />
					<h2 class="text-custom-black-80 fw-bold mb-0 ms-3">Aadhaar Card</h2>
				</div>
				<div class="d-flex justify-content-between">
					<span class="text-custom-black-80" *ngIf="aadharCard?.updatedAt">
						Document Submitted on: {{ aadharCard?.updatedAt | date: 'dd/MM/yyyy' }}
					</span>
					<ng-container
						*ngIf="
							[roles.EMPLOYEE].includes(currentUser?.role) &&
							![verificationLevel.CLEAR_REPORT].includes(form['status'].value) &&
							form['id'].value
						"
					>
						<span class="mx-2" role="button" (click)="openConfirmDelete(item)" ngbTooltip="Delete">
							<iconify-icon class="fs-5 text-primary" icon="ant-design:delete-outlined"></iconify-icon>
						</span>
					</ng-container>
				</div>
			</div>
		</div>
		<div class="card-body">
			<div class="row">
				<div class="col-lg-6 col-md-10 col-sm-12">
					<div class="card border-0 bg-primary-200 rounded" *ngIf="aadharCard?.additionalDetails">
						<div class="card-body">
							<div class="row align-items-center">
								<div class="col-5 text-start" *ngIf="aadharCard?.additionalDetails?.profilePicture">
									<img
										class="rounded-circle"
										src="{{
											'data:image/jpg;base64,' + aadharCard?.additionalDetails?.profilePicture
										}}"
										height="75"
										width="75"
									/>
								</div>
								<div class="col-7">
									<p class="text-primary fs-5" *ngIf="aadharCard?.additionalDetails?.fullName">
										<strong>{{ aadharCard?.additionalDetails?.fullName }}</strong>
									</p>
								</div>
							</div>
							<div class="row mb-1">
								<div class="col-5">
									<strong class="text-primary-300">Aadhaar Number:</strong>
								</div>
								<div class="col-7">
									<span class="text-primary-300">{{ aadharCard?.cardNumber }}</span>
								</div>
							</div>
							<div class="row mb-1 justify-content-between">
								<div class="col-5">
									<strong class="text-primary-300">Address:</strong>
								</div>
								<div class="col-7 text-primary-300" *ngIf="aadharCard?.additionalDetails?.address">
									<span *ngIf="aadharCard?.additionalDetails?.address?.house"
										>{{ aadharCard?.additionalDetails?.address?.house }},</span
									>
									<span *ngIf="aadharCard?.additionalDetails?.address?.loc"
										>{{ aadharCard?.additionalDetails?.address?.loc }},</span
									>
									<span *ngIf="aadharCard?.additionalDetails?.address?.landmark"
										>{{ aadharCard?.additionalDetails?.address?.landmark }},</span
									>
									<span *ngIf="aadharCard?.additionalDetails?.address?.street"
										>{{ aadharCard?.additionalDetails?.address?.street }},</span
									>
									<span *ngIf="aadharCard?.additionalDetails?.address?.dist"
										>{{ aadharCard?.additionalDetails?.address?.dist }},</span
									>
									{{ aadharCard?.additionalDetails?.address?.state }}, PIN:
									{{ aadharCard?.additionalDetails?.address?.pincode }}
								</div>
								<div
									class="col-7 text-primary-300"
									*ngIf="
										aadharCard?.additionalDetails?.inputAddress &&
										!aadharCard?.additionalDetails?.address?.house
									"
								>
									<span>{{ aadharCard?.additionalDetails?.inputAddress }}</span>
									{{ aadharCard?.additionalDetails?.city }}
									{{ aadharCard?.additionalDetails?.state }}, PIN:
									{{ aadharCard?.additionalDetails?.pincode }}
								</div>
							</div>
							<div class="row mb-1">
								<div class="col-5">
									<strong class="text-primary-300">Date of Birth:</strong>
								</div>
								<div class="col-7">
									<span class="text-primary-300">{{ aadharCard?.additionalDetails?.dob }}</span>
								</div>
							</div>
							<div class="row mb-1">
								<div class="col-5">
									<strong class="text-primary-300">Father's Name:</strong>
								</div>
								<div class="col-7">
									<span class="text-primary-300">{{
										aadharCard?.additionalDetails?.parentName || '-'
									}}</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<form [formGroup]="dataForm">
				<div class="row align-items-center">
					<div class="col-lg-10 col-md-10 col-sm-12 py-2">
						<label class="form-label text-custom-black">
							<span canViewEnterAttach>Enter</span> Aadhaar Card Number</label
						>
						<input
							type="text"
							class="form-control"
							id="cardNumber"
							placeholder="Enter Aadhaar Number"
							(keypress)="numberOnly($event)"
							formControlName="cardNumber"
							[maxLength]="14"
							[readonly]="form['id'].value"
						/>

						<div class="text-left" *ngFor="let error of errorMessages?.cardNumber">
							<ng-container
								*ngIf="
									form['cardNumber'].hasError(error.type) &&
									(form['cardNumber'].dirty || form['cardNumber'].touched)
								"
							>
								<span class="text-danger">{{ error.message }}</span>
							</ng-container>
						</div>
					</div>
					<div
						class="col-lg-2 col-md-2 col-sm-12 text-end pt-2"
						*ngIf="form['id'].value && aadharCard?.additionalDetails?.profilePicture"
					>
						<button class="btn w-100 btn-white-100 mt-3">
							<img src="assets/icons/check-circle-broken.svg" class="img-fluid" />
							<span class="fw-bold text-custom-black ms-1">Verified</span>
						</button>
					</div>
				</div>

				<div class="row justify-content-between align-items-end py-2" *ngIf="otpSend">
					<div class="col-lg-9 col-md-8 col-sm-12">
						<label for="exampleFormControlInput1" class="form-label text-custom-black">Enter OTP</label>
						<input
							type="number"
							class="form-control"
							id="otp"
							placeholder=""
							(keypress)="numberOnly($event)"
							formControlName="otp"
						/>
					</div>
					<div class="col-lg-3 col-md-4 col-sm-12">
						<button
							type="button"
							[disabled]="dataForm.invalid"
							class="btn btn-primary w-100 px-4"
							(click)="verifyAadhar()"
						>
							Submit
						</button>
					</div>
				</div>
				<div class="d-flex justify-content-between" *ngIf="otpSend">
					<p class="text-primary">An OTP has been sent to your registered mobile number</p>
					<span class="text-primary" *ngIf="canResendAadharOTP; else ResendMin">
						Did not receive the OTP?
						<a class="text-primary fw-bolder" role="button" (click)="requestOtp()">Resend</a>
					</span>
					<ng-template #ResendMin class="text-primary mb-0">
						Resend OTP in <strong>{{ minutes }}:{{ seconds }}</strong>
					</ng-template>
				</div>

				<div class="row justify-content-between align-items-end py-2">
					<div class="col-lg-6 col-md-12 col-sm-12">
						<label class="form-label text-custom-black">
							<span canViewEnterAttach>Attach</span> Aadhaar Card Front Image
						</label>
						<input
							hidden
							#fileInput
							type="file"
							class="form-control"
							(change)="uploadFile($event, 'frontImage')"
							accept="image/png,image/jpg,image/jpeg"
						/>
						<div class="input-group file-input-group">
							<input
								type="text"
								readonly
								class="form-control"
								aria-label="Aadhaar Card Front image"
								[placeholder]="
									!form['frontImage'].value ? 'Choose file to upload' : 'Aadhaar Card Front image'
								"
								[ngClass]="
									!form['frontImage'].value &&
									![
										roles.PROTO_SUPER_ADMIN,
										roles.PROTO_ADMIN,
										roles.PROTO_USER,
										roles.PROTO_OPERATION,
										roles.EMPLOYEE
									].includes(currentUser?.role)
										? 'border-end-1 rounded-end'
										: 'border-end-0'
								"
							/>
							<span
								role="button"
								class="input-group-text bg-transparent border-start-0 border-end-0"
								*ngIf="form['frontImage'].value"
								(click)="!form['frontImage'].value ? null : showImage(form['frontImage'].value)"
								ngbTooltip="View"
							>
								<iconify-icon class="fs-5 text-primary" icon="iconamoon:eye"> </iconify-icon>
							</span>
							<span
								role="button"
								class="input-group-text bg-transparent border-start-0"
								*ngIf="form['frontImage'].value"
								(click)="!form['frontImage'].value ? null : downloadDocument(form['frontImage'].value)"
								ngbTooltip="Download"
								[ngClass]="{
									'border-end-1 rounded-end': ![
										roles.PROTO_SUPER_ADMIN,
										roles.PROTO_ADMIN,
										roles.PROTO_USER,
										roles.PROTO_OPERATION,
										roles.EMPLOYEE
									].includes(currentUser?.role),
									'border-end-0':
										[
											roles.PROTO_SUPER_ADMIN,
											roles.PROTO_ADMIN,
											roles.PROTO_USER,
											roles.PROTO_OPERATION,
											roles.EMPLOYEE
										].includes(currentUser?.role) &&
										dataForm?.value?.status !== verificationLevel?.CLEAR_REPORT,
									'border-end-1 rounded-end':
										dataForm?.value?.status === verificationLevel?.CLEAR_REPORT
								}"
							>
								<iconify-icon class="fs-5 text-primary" icon="bi:download"> </iconify-icon>
							</span>

							<ng-container *ngIf="[roles.EMPLOYEE].includes(currentUser?.role)">
								<span
									role="button"
									class="input-group-text bg-transparent border-start-0 rounded-end"
									(click)="fileInput.click()"
									*ngIf="!form['frontImage'].value"
									ngbTooltip="Upload File"
								>
									<iconify-icon class="fs-5 text-primary" icon="iconoir:attachment"> </iconify-icon>
								</span>
								<span
									role="button"
									class="input-group-text bg-transparent border-start-0 rounded-end"
									(click)="clearFile('frontImage')"
									*ngIf="form['frontImage'].value"
									[hidden]="dataForm?.value?.status === verificationLevel?.CLEAR_REPORT"
									ngbTooltip="Remove"
								>
									<iconify-icon class="fs-5 text-primary" icon="ant-design:delete-outlined">
									</iconify-icon>
								</span>
							</ng-container>
							<ng-container
								*ngIf="
									[
										roles.PROTO_SUPER_ADMIN,
										roles.PROTO_ADMIN,
										roles.PROTO_USER,
										roles.PROTO_OPERATION
									].includes(currentUser?.role)
								"
							>
								<ng-container *appIsGranted="'EDIT'">
									<span
										role="button"
										class="input-group-text bg-transparent border-start-0 rounded-end"
										(click)="dataForm.disabled ? null : fileInput.click()"
										*ngIf="!form['frontImage'].value"
										ngbTooltip="Upload File"
									>
										<iconify-icon class="fs-5 text-primary" icon="iconoir:attachment">
										</iconify-icon>
									</span>
									<span
										role="button"
										class="input-group-text bg-transparent border-start-0 rounded-end"
										(click)="dataForm.disabled ? null : clearFile('frontImage')"
										*ngIf="form['frontImage'].value"
										[hidden]="dataForm?.value?.status === verificationLevel?.CLEAR_REPORT"
										ngbTooltip="Remove"
									>
										<iconify-icon class="fs-5 text-primary" icon="ant-design:delete-outlined">
										</iconify-icon>
									</span>
								</ng-container>
							</ng-container>
						</div>
						<div class="text-left" *ngFor="let error of errorMessages?.frontImage">
							<ng-container
								*ngIf="
									form['frontImage'].hasError(error.type) &&
									(form['frontImage'].dirty || form['frontImage'].touched)
								"
							>
								<span class="text-danger">{{ error.message }}</span>
							</ng-container>
						</div>
					</div>
					<div class="col-lg-6 col-md-12 col-sm-12">
						<label class="form-label text-custom-black">
							<span canViewEnterAttach>Attach</span> Aadhaar Card Back Image
						</label>
						<input
							hidden
							#fileInput2
							type="file"
							class="form-control"
							(change)="uploadFile($event, 'backImage')"
							accept="image/png,image/jpg,image/jpeg"
						/>
						<div class="input-group file-input-group">
							<input
								type="text"
								readonly
								class="form-control"
								aria-label="Aadhaar Card back image"
								[placeholder]="
									!form['backImage'].value ? 'Choose file to upload' : 'Aadhaar Card back image'
								"
								[ngClass]="
									!form['backImage'].value &&
									![
										roles.PROTO_SUPER_ADMIN,
										roles.PROTO_ADMIN,
										roles.PROTO_USER,
										roles.PROTO_OPERATION,
										roles.EMPLOYEE
									].includes(currentUser?.role)
										? 'border-end-1 rounded-end'
										: 'border-end-0'
								"
							/>
							<span
								role="button"
								class="input-group-text bg-transparent border-start-0 border-end-0"
								*ngIf="form['backImage'].value"
								(click)="!form['backImage'].value ? null : showImage(form['backImage'].value)"
								ngbTooltip="View"
							>
								<iconify-icon class="fs-5 text-primary" icon="iconamoon:eye"> </iconify-icon>
							</span>
							<span
								role="button"
								class="input-group-text bg-transparent border-start-0"
								*ngIf="form['backImage'].value"
								(click)="!form['backImage'].value ? null : downloadDocument(form['backImage'].value)"
								ngbTooltip="Download"
								[ngClass]="{
									'border-end-1 rounded-end': ![
										roles.PROTO_SUPER_ADMIN,
										roles.PROTO_ADMIN,
										roles.PROTO_USER,
										roles.PROTO_OPERATION,
										roles.EMPLOYEE
									].includes(currentUser?.role),
									'border-end-0':
										[
											roles.PROTO_SUPER_ADMIN,
											roles.PROTO_ADMIN,
											roles.PROTO_USER,
											roles.PROTO_OPERATION,
											roles.EMPLOYEE
										].includes(currentUser?.role) &&
										dataForm?.value?.status !== verificationLevel?.CLEAR_REPORT,
									'border-end-1 rounded-end':
										[roles.EMPLOYEE] && dataForm?.value?.status === verificationLevel?.CLEAR_REPORT
								}"
							>
								<iconify-icon class="fs-5 text-primary" icon="bi:download"> </iconify-icon>
							</span>

							<ng-container *ngIf="[roles.EMPLOYEE].includes(currentUser?.role)">
								<span
									role="button"
									class="input-group-text bg-transparent border-start-0 rounded-end"
									(click)="fileInput2.click()"
									*ngIf="!form['backImage'].value"
									ngbTooltip="Upload File"
								>
									<iconify-icon class="fs-5 text-primary" icon="iconoir:attachment"> </iconify-icon>
								</span>
								<span
									role="button"
									class="input-group-text bg-transparent border-start-0 rounded-end"
									(click)="clearFile('backImage')"
									*ngIf="form['backImage'].value"
									[hidden]="dataForm?.value?.status === verificationLevel?.CLEAR_REPORT"
									ngbTooltip="Remove"
								>
									<iconify-icon class="fs-5 text-primary" icon="ant-design:delete-outlined">
									</iconify-icon>
								</span>
							</ng-container>
							<ng-container
								*ngIf="
									[
										roles.PROTO_SUPER_ADMIN,
										roles.PROTO_ADMIN,
										roles.PROTO_USER,
										roles.PROTO_OPERATION
									].includes(currentUser?.role)
								"
							>
								<ng-container *appIsGranted="'EDIT'">
									<span
										role="button"
										class="input-group-text bg-transparent border-start-0 rounded-end"
										(click)="dataForm.disabled ? null : fileInput2.click()"
										*ngIf="!form['backImage'].value"
										ngbTooltip="Upload File"
									>
										<iconify-icon class="fs-5 text-primary" icon="iconoir:attachment">
										</iconify-icon>
									</span>
									<span
										role="button"
										class="input-group-text bg-transparent border-start-0 rounded-end"
										(click)="dataForm.disabled ? null : clearFile('backImage')"
										*ngIf="form['backImage'].value"
										[hidden]="dataForm?.value?.status === verificationLevel?.CLEAR_REPORT"
										ngbTooltip="Remove"
									>
										<iconify-icon class="fs-5 text-primary" icon="ant-design:delete-outlined">
										</iconify-icon>
									</span>
								</ng-container>
							</ng-container>
						</div>
						<div class="text-left" *ngFor="let error of errorMessages?.backImage">
							<ng-container
								*ngIf="
									form['backImage'].hasError(error.type) &&
									(form['backImage'].dirty || form['backImage'].touched)
								"
							>
								<span class="text-danger">{{ error.message }}</span>
							</ng-container>
						</div>
					</div>
				</div>
				<div class="d-flex justify-content-end gap-4" *ngIf="!aadharCard?.additionalDetails?.profilePicture">
					<ng-container *ngIf="currentUser.role === roles.EMPLOYEE">
						<button
							type="button"
							class="btn btn-outline-primary mt-3"
							(click)="addAadharCardAddress()"
							*ngIf="!aadharVerified && currentUser.role != roles.PROTO_LAWYER && !otpSend"
						>
							Save as draft
						</button>
						<button
							type="button"
							class="btn btn-primary mt-3"
							(click)="onSubmit()"
							*ngIf="!aadharVerified && currentUser.role != roles.PROTO_LAWYER && !otpSend"
						>
							Save and verify
						</button>
					</ng-container>
					<ng-container *ngIf="currentUser.role !== roles.EMPLOYEE">
						<ng-container *appIsGranted="'ADD'">
							<button
								type="button"
								class="btn btn-outline-primary mt-3"
								(click)="addAadharCardAddress()"
								*ngIf="!aadharVerified && currentUser.role != roles.PROTO_LAWYER && !otpSend"
								[disabled]="dataForm.disabled"
							>
								Save as draft
							</button>
							<button
								type="button"
								class="btn btn-primary mt-3"
								(click)="onSubmit()"
								*ngIf="!aadharVerified && currentUser.role != roles.PROTO_LAWYER && !otpSend"
								[disabled]="dataForm.disabled"
							>
								Save and verify
							</button>
						</ng-container>
					</ng-container>
				</div>
				<div class="row" *ngIf="dataForm?.value?.status && ![roles.EMPLOYEE].includes(currentUser?.role)">
					<div class="col-12 mb-3">
						<div class="form-group">
							<label class="form-label text-custom-black">Remarks</label>
							<textarea
								type="text"
								class="form-control"
								id="remark"
								placeholder="Write your remarks here"
								rows="4"
								formControlName="remark"
								[readOnly]="
									dataForm?.value?.status === kycStatus?.APPROVED ||
									![roles.PROTO_SUPER_ADMIN, roles.PROTO_ADMIN, roles.PROTO_OPERATION].includes(
										currentUser?.role
									)
								"
							></textarea>
							<div class="text-left" *ngFor="let error of errorMessages?.remark">
								<ng-container
									*ngIf="
										form['remark'].hasError(error.type) &&
										(form['remark'].dirty || form['remark'].touched)
									"
								>
									<span class="text-danger">{{ error.message }}</span>
								</ng-container>
							</div>
						</div>
					</div>
				</div>
			</form>
			<div class="gap-1" *appIsGranted="'EDIT'">
				<div
					class="d-flex justify-content-end gap-1"
					*ngIf="[roles.PROTO_SUPER_ADMIN, roles.PROTO_ADMIN].includes(currentUser?.role) && form['id'].value"
				>
					<button type="button" class="btn btn-outline-danger text-capitalize" (click)="openConfirmStatus()">
						Discrepancy
					</button>
					<button
						type="button"
						class="btn btn-success"
						(click)="openConfirmStatus(verificationLevel.CLEAR_REPORT)"
					>
						Clear Report
					</button>
				</div>
				<div
					class="d-flex justify-content-between gap-1"
					*ngIf="[roles.PROTO_OPERATION].includes(currentUser?.role) && form['id'].value"
				>
					<button
						type="button"
						class="btn btn-outline-danger text-capitalize"
						(click)="openConfirmStatus(verificationLevel.MAJOR_DISCREPANCY)"
						[disabled]="dataForm.disabled"
					>
						Major Discrepancy
					</button>
					<button
						type="button"
						class="btn btn-outline-primary text-capitalize"
						(click)="openConfirmStatus('others')"
						[disabled]="dataForm.disabled"
					>
						others
					</button>
					<button
						type="button"
						class="btn btn-success"
						(click)="openConfirmStatus(verificationLevel.CLEAR_REPORT)"
						[disabled]="dataForm.disabled"
					>
						Clear Report
					</button>
				</div>
			</div>
		</div>
	</div>

	<div class="d-flex justify-content-end">
		<button type="button" class="btn-preview border-0" (click)="goBack()">
			<img src="assets/icons/arrow-left.svg" class="img-fluid" alt="clip" /> Previous
		</button>
		<button type="button" class="btn-next border-0" (click)="goNext()">
			Next <img src="assets/icons/arrow-right.svg" class="img-fluid" alt="clip" />
		</button>
	</div>

	<div class="mt-4" *ngIf="![roles.EMPLOYEE].includes(currentUser?.role)">
		<app-verification-status></app-verification-status>
	</div>
</div>
