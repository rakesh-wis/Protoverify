<div class="container-fluid page-padding">
	<div
		class="d-flex justify-content-between align-items-center"
		*ngIf="![roles.EMPLOYEE].includes(currentUser?.role)"
	>
		<label class="text-custom-black-80 fs-4 fw-bold"> {{ userData?.name }}'s Verification Details </label>
	</div>
	<div *ngIf="![roles.EMPLOYEE].includes(currentUser?.role)">
		<app-status-bar
			[checkName]="form['type'].value"
			[inputData]="form['id'].value ? dataForm.getRawValue() : null"
			[currentUser]="currentUser"
		></app-status-bar>
	</div>
	<div class="card my-4 px-3" [ngClass]="{ 'opacity-50': isFormDisabled }">
		<div class="card-header bg-transparent">
			<div class="d-flex justify-content-between align-items-center">
				<div class="d-flex justify-content-start align-items-center py-2">
					<img src="assets/images/kyc_self.svg" class="img-fluid" />
					<h2 class="text-custom-black-80 fw-bold mb-0 ms-3">Self Address Verification</h2>
				</div>
				<span class="text-custom-black-80" *ngIf="selfVerification?.updatedAt">
					Document Submitted on: {{ selfVerification?.updatedAt | date: 'dd/MM/yyyy' }}
				</span>
			</div>
		</div>
		<div
			class="card-body"
			*ngIf="
				!form['id'].value &&
				![roles.PROTO_SUPER_ADMIN, roles.PROTO_ADMIN, roles.EMPLOYEE].includes(currentUser.role)
			"
		>
			<div class="my-4 d-flex justify-content-center">Process controlled by Protoverify App</div>
		</div>
		<div
			class="card-body"
			*ngIf="
				form['id'].value ||
				[roles.PROTO_SUPER_ADMIN, roles.PROTO_ADMIN, roles.EMPLOYEE].includes(currentUser.role)
			"
		>
			<form [formGroup]="dataForm">
				<div class="row">
					<div class="col-lg-12 col-md-12 col-sm-12">
						<div class="form-group">
							<label class="form-label text-custom-black">Address line 1</label>
							<input
								type="text"
								class="form-control l bg-transparent"
								id="addressLine1"
								placeholder="Enter here"
								formControlName="addressLine1"
							/>
							<div class="text-left" *ngFor="let error of errorMessages?.addressLine1">
								<ng-container
									*ngIf="
										form['addressLine1'].hasError(error.type) &&
										(form['addressLine1'].dirty || form['addressLine1'].touched)
									"
								>
									<span class="text-danger">{{ error.message }}</span>
								</ng-container>
							</div>
						</div>
					</div>
					<div class="col-lg-6 col-md-6 col-sm-12">
						<div class="form-group">
							<label class="form-label text-custom-black">Pincode</label>
							<input
								type="text"
								class="form-control l bg-transparent"
								id="pincode"
								placeholder="Enter pincode"
								formControlName="pincode"
								(keypress)="numberOnly($event)"
								maxlength="8"
							/>
							<div class="text-left" *ngFor="let error of errorMessages?.pincode">
								<ng-container
									*ngIf="
										form['pincode'].hasError(error.type) &&
										(form['pincode'].dirty || form['pincode'].touched)
									"
								>
									<span class="text-danger">{{ error.message }}</span>
								</ng-container>
							</div>
						</div>
					</div>
					<div class="col-lg-6 col-md-6 col-sm-12">
						<div class="form-group">
							<label class="form-label text-primary"> Type of Ownership </label>
							<select
								class="form-select text-capitalize"
								aria-label="select type"
								formControlName="ownershipType"
							>
								<option [value]="item" *ngFor="let item of ownershipType">
									<span>{{ item }}</span>
								</option>
							</select>
							<div class="text-left" *ngFor="let error of errorMessages.ownershipType">
								<ng-container
									*ngIf="
										form['ownershipType'].hasError(error.type) &&
										(form['ownershipType'].dirty || form['ownershipType'].touched)
									"
								>
									<span class="text-danger">{{ error.message }}</span>
								</ng-container>
							</div>
						</div>
					</div>
				</div>
				<div class="row my-2">
					<div
						class="col-lg-6 col-md-6 col-sm-12"
						*ngFor="let _ of verificationMedia.controls; let i = index"
					>
						<div class="form-group">
							<label class="form-label text-primary"> {{ _.value.label }} </label>
							<input
								hidden
								#fileInput0
								type="file"
								class="form-control"
								onclick="this.value = null"
								accept="image/png,image/jpg,image/jpeg"
								(change)="uploadFile($event, i)"
								capture
								*ngIf="i == 0"
							/>
							<input
								hidden
								#fileInput1
								type="file"
								class="form-control"
								onclick="this.value = null"
								accept="image/png,image/jpg,image/jpeg"
								(change)="uploadFile($event, i)"
								capture
								*ngIf="i == 1"
							/>
							<div class="input-group file-input-group">
								<input
									type="text"
									readonly
									class="form-control"
									[aria-label]="_.value.label"
									[placeholder]="_.value.label"
									[ngClass]="
										!_.value.filePath &&
										![
											roles.PROTO_SUPER_ADMIN,
											roles.PROTO_ADMIN,
											roles.PROTO_USER,
											roles.PROTO_OPERATION,
											roles.EMPLOYEE
										].includes(currentUser?.role)
											? 'border-end-1 rounded-end'
											: 'border-end-0'
									"
								/>
								<span
									role="button"
									class="input-group-text bg-transparent border-start-0 border-end-0"
									*ngIf="_.value.filePath"
									(click)="!_.value.filePath ? null : showImage(_.value.filePath)"
									ngbTooltip="View"
								>
									<iconify-icon class="fs-5 text-primary" icon="iconamoon:eye"> </iconify-icon>
								</span>
								<span
									role="button"
									class="input-group-text bg-transparent border-start-0"
									*ngIf="_.value.filePath"
									(click)="!_.value.filePath ? null : downloadDocument(_.value.filePath)"
									ngbTooltip="Download"
									[ngClass]="
										![
											roles.PROTO_SUPER_ADMIN,
											roles.PROTO_ADMIN,
											roles.PROTO_USER,
											roles.PROTO_OPERATION,
											roles.EMPLOYEE
										].includes(currentUser?.role)
											? 'border-end-1 rounded-end'
											: 'border-end-0'
									"
								>
									<iconify-icon class="fs-5 text-primary" icon="bi:download"> </iconify-icon>
								</span>

								<ng-container *ngIf="[roles.EMPLOYEE].includes(currentUser?.role)">
									<span
										role="button"
										class="input-group-text bg-transparent border-start-0 rounded-end"
										(click)="dataForm.disabled ? null : openCamera(i)"
										*ngIf="!_.value.filePath"
										ngbTooltip="Upload File"
									>
										<iconify-icon class="fs-5 text-primary" icon="iconoir:attachment">
										</iconify-icon>
									</span>
									<span
										role="button"
										class="input-group-text bg-transparent border-start-0 rounded-end"
										*ngIf="_.value.filePath"
										(click)="dataForm.disabled ? null : setControl(_.value, true, i)"
										ngbTooltip="Remove"
									>
										<iconify-icon class="fs-5 text-primary" icon="ant-design:delete-outlined">
										</iconify-icon>
									</span>
								</ng-container>
								<ng-container
									*ngIf="
										[
											roles.PROTO_SUPER_ADMIN,
											roles.PROTO_ADMIN,
											roles.PROTO_USER,
											roles.PROTO_OPERATION
										].includes(currentUser?.role)
									"
								>
									<ng-container *appIsGranted="'EDIT'">
										<span
											role="button"
											class="input-group-text bg-transparent border-start-0 rounded-end"
											(click)="dataForm.disabled ? null : openCamera(i)"
											*ngIf="!_.value.filePath"
											ngbTooltip="Upload File"
										>
											<iconify-icon class="fs-5 text-primary" icon="iconoir:attachment">
											</iconify-icon>
										</span>
										<span
											role="button"
											class="input-group-text bg-transparent border-start-0 rounded-end"
											*ngIf="_.value.filePath"
											(click)="dataForm.disabled ? null : setControl(_.value, true, i)"
											ngbTooltip="Remove"
										>
											<iconify-icon class="fs-5 text-primary" icon="ant-design:delete-outlined">
											</iconify-icon>
										</span>
									</ng-container>
								</ng-container>
							</div>
							<div class="text-left" *ngFor="let error of errorMessages.filePath">
								<ng-container
									*ngIf="
										_.controls['filePath'].hasError(error.type) &&
										(_.controls['filePath'].dirty || _.controls['filePath'].touched)
									"
								>
									<span class="text-danger">{{ error.message }}</span>
								</ng-container>
							</div>
						</div>
					</div>
				</div>
				<div class="row my-2">
					<div class="col-lg-6 col-md-10 col-sm-12">
						<div class="card border-0 bg-primary-200 rounded" *ngIf="form['additionalDetails'].value">
							<div class="card-body">
								<div class="row align-items-center">
									<!-- <div class="col-5 text-start">

									</div> -->
									<div class="col-sm-12">
										<label class="text-primary fw-bold"> Address: </label>
										<p class="text-primary">
											{{ form['additionalDetails'].value['formattedAddress'] }}
										</p>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-lg-6 col-md-10 col-sm-12">
						<div class="card border-0 bg-primary-200 rounded" *ngIf="form['geometry'].value">
							<div class="card-body">
								<div class="row align-items-start">
									<div class="col-1 text-start">
										<iconify-icon class="fs-5 text-primary" icon="gis:location-poi"> </iconify-icon>
									</div>
									<div class="col-10">
										<label class="text-primary fw-bold">Latitude and Longitude</label>
										<p class="text-primary mb-0">
											Latitude: {{ form['geometry'].value['coordinates'][0] }}
										</p>
										<p class="text-primary">
											Longitude: {{ form['geometry'].value['coordinates'][1] }}
										</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-6 col-md-6 col-sm-12" formGroupName="periodOfStay">
						<div class="form-group">
							<label class="form-label text-primary"> Period of stay in Number of Years & Months</label>
							<div class="input-group mb-0">
								<input
									type="text"
									class="form-control"
									formControlName="years"
									placeholder="0-100"
									aria-label="Year"
									(keypress)="numberOnly($event)"
									maxlength="3"
								/>
								<select
									class="form-select text-capitalize"
									aria-label="Number of months"
									placeholder="Number of months"
									formControlName="months"
								>
									<option value="" selected disabled [hidden]="periodOfStayForm['months'].value">
										Number of months
									</option>
									<option [value]="item" *ngFor="let item of months">
										<span>{{ item }}</span>
									</option>
								</select>
							</div>
							<p class="text-secondary mb-0">Years can be from 0-100</p>
							<span class="text-left" *ngFor="let error of errorMessages?.years">
								<ng-container
									*ngIf="
										periodOfStayForm['years'].hasError(error.type) &&
										(periodOfStayForm['years'].dirty || periodOfStayForm['years'].touched)
									"
								>
									<span class="text-danger">{{ error.message }}</span>
								</ng-container>
							</span>
							<span
								class="text-danger px-1"
								*ngIf="
									!periodOfStayForm['years'].value &&
									(periodOfStayForm['years'].dirty || periodOfStayForm['years'].touched) &&
									(periodOfStayForm['months'].dirty || periodOfStayForm['months'].touched)
								"
								>&</span
							>
							<span class="text-left" *ngFor="let error of errorMessages?.months">
								<ng-container
									*ngIf="
										periodOfStayForm['months'].hasError(error.type) &&
										(periodOfStayForm['months'].dirty || periodOfStayForm['months'].touched)
									"
								>
									<span class="text-danger">{{ error.message }}</span>
								</ng-container>
							</span>
						</div>
					</div>
					<div class="col-lg-6 col-md-6 col-sm-12">
						<div class="form-group">
							<label class="form-label text-primary"> Type of Accommodation </label>
							<select
								class="form-select text-capitalize"
								aria-label="select type"
								formControlName="accommodationType"
							>
								<option [value]="item" *ngFor="let item of accommodationType">
									<span>{{ item.replaceAll('_', ' ') }}</span>
								</option>
							</select>
							<div class="text-left" *ngFor="let error of errorMessages.accommodationType">
								<ng-container
									*ngIf="
										form['accommodationType'].hasError(error.type) &&
										(form['accommodationType'].dirty || form['accommodationType'].touched)
									"
								>
									<span class="text-danger">{{ error.message }}</span>
								</ng-container>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-lg-6 col-md-6 col-sm-12">
						<div class="form-group">
							<label class="form-label text-primary"> Type of Address </label>
							<select
								class="form-select text-capitalize"
								aria-label="select type"
								formControlName="addressType"
							>
								<option [value]="item" *ngFor="let item of addressType">
									<span>{{ item }}</span>
								</option>
							</select>
							<div class="text-left" *ngFor="let error of errorMessages.addressType">
								<ng-container
									*ngIf="
										form['addressType'].hasError(error.type) &&
										(form['addressType'].dirty || form['addressType'].touched)
									"
								>
									<span class="text-danger">{{ error.message }}</span>
								</ng-container>
							</div>
						</div>
					</div>
				</div>
				<div class="d-flex justify-content-end my-2">
					<ng-container *ngIf="[roles.EMPLOYEE].includes(currentUser?.role) && !form['id'].value">
						<button type="button" class="btn btn-primary" (click)="onSubmit()">Submit</button>
					</ng-container>
					<ng-container
						*ngIf="
							[
								roles.PROTO_SUPER_ADMIN,
								roles.PROTO_ADMIN,
								roles.PROTO_USER,
								roles.PROTO_OPERATION
							].includes(currentUser?.role)
						"
					>
						<button
							type="button"
							class="btn btn-primary"
							(click)="onSubmit()"
							*appIsGranted="'ADD'"
							[disabled]="dataForm.disabled"
						>
							Submit
						</button>
					</ng-container>
				</div>
				<div
					class="row"
					*ngIf="
						[
							roles.PROTO_SUPER_ADMIN,
							roles.PROTO_ADMIN,
							roles.PROTO_LAWYER,
							roles.PROTO_OPERATION
						].includes(currentUser?.role) && form['id'].value
					"
				>
					<div class="col-12 mb-3">
						<div class="form-group">
							<label class="form-label text-primary">Remarks</label>
							<textarea
								type="text"
								class="form-control"
								id="remark"
								placeholder="Write your remarks here"
								rows="4"
								formControlName="remark"
								[readOnly]="
									dataForm?.value?.status === kycStatus?.APPROVED ||
									![roles.PROTO_SUPER_ADMIN, roles.PROTO_ADMIN, roles.PROTO_OPERATION].includes(
										currentUser?.role
									)
								"
							></textarea>
							<div class="text-left" *ngFor="let error of errorMessages?.remark">
								<ng-container
									*ngIf="
										form['remark'].hasError(error.type) &&
										(form['remark'].dirty || form['remark'].touched)
									"
								>
									<span class="text-danger">{{ error.message }}</span>
								</ng-container>
							</div>
						</div>
					</div>
				</div>
			</form>

			<div class="gap-1" *appIsGranted="'EDIT'">
				<div
					class="d-flex justify-content-end gap-1"
					*ngIf="[roles.PROTO_SUPER_ADMIN, roles.PROTO_ADMIN].includes(currentUser?.role) && form['id'].value"
				>
					<button type="button" class="btn btn-outline-danger text-capitalize" (click)="openConfirmStatus()">
						Discrepancy
					</button>
					<button
						type="button"
						class="btn btn-success"
						(click)="openConfirmStatus(verificationLevel.CLEAR_REPORT)"
					>
						Clear Report
					</button>
				</div>
				<div
					class="d-flex justify-content-between gap-1"
					*ngIf="[roles.PROTO_OPERATION].includes(currentUser?.role) && form['id'].value"
				>
					<button
						type="button"
						class="btn btn-outline-danger text-capitalize"
						(click)="openConfirmStatus(verificationLevel.MAJOR_DISCREPANCY)"
						[disabled]="dataForm.disabled"
					>
						Major Discrepancy
					</button>
					<button
						type="button"
						class="btn btn-outline-primary text-capitalize"
						(click)="openConfirmStatus('others')"
						[disabled]="dataForm.disabled"
					>
						others
					</button>
					<button
						type="button"
						class="btn btn-success"
						(click)="openConfirmStatus(verificationLevel.CLEAR_REPORT)"
						[disabled]="dataForm.disabled"
					>
						Clear Report
					</button>
				</div>
			</div>
		</div>
	</div>

	<div class="d-flex justify-content-end">
		<button type="button" class="btn-preview border-0" (click)="goBack()">
			<img src="assets/icons/arrow-left.svg" class="img-fluid" alt="clip" /> Previous
		</button>
		<button type="button" class="btn-next border-0" (click)="goNext()">
			Next <img src="assets/icons/arrow-right.svg" class="img-fluid" alt="clip" />
		</button>
	</div>
	<div class="mt-4" *ngIf="![roles.EMPLOYEE].includes(currentUser?.role)">
		<app-verification-status></app-verification-status>
	</div>
</div>
